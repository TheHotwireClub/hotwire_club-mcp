#!/usr/bin/env ruby
# frozen_string_literal: true

# Only use bundler/setup in development (when Gemfile exists in parent directory)
# When installed as a gem, the Gemfile won't exist, so just require the gem directly
gemfile_path = File.expand_path(File.join(__dir__, "..", "Gemfile"))
if File.exist?(gemfile_path)
  require "bundler/setup"
end

require "hotwire_club/mcp"

# Find the database path:
# 1. In development: look in current directory's db/ folder
# 2. When installed as gem: look in gem's installation directory
# Uses best-effort approach: prefers kb-pro.sqlite, falls back to kb.sqlite
def find_database_path
  # Check if we're in development (Gemfile exists)
  gemfile_path = File.expand_path(File.join(__dir__, "..", "Gemfile"))
  if File.exist?(gemfile_path)
    # Development: use current directory
    # Try pro database first, then fall back to free
    dev_pro_db_path = File.join(Dir.pwd, "db", "kb-pro.sqlite")
    return dev_pro_db_path if File.exist?(dev_pro_db_path)

    dev_db_path = File.join(Dir.pwd, "db", "kb.sqlite")
    return dev_db_path if File.exist?(dev_db_path)
  end

  # Installed as gem: find gem root directory
  # The executable is in exe/, so go up to gem root
  gem_root = File.expand_path(File.join(__dir__, ".."))
  # Try pro database first, then fall back to free
  gem_pro_db_path = File.join(gem_root, "db", "kb-pro.sqlite")
  return gem_pro_db_path if File.exist?(gem_pro_db_path)

  gem_db_path = File.join(gem_root, "db", "kb.sqlite")
  return gem_db_path if File.exist?(gem_db_path)

  # Fallback to current directory (for backward compatibility)
  # Try pro first, then free
  fallback_pro_path = File.join(Dir.pwd, "db", "kb-pro.sqlite")
  return fallback_pro_path if File.exist?(fallback_pro_path)

  File.join(Dir.pwd, "db", "kb.sqlite")
end

db_path = find_database_path
database = HotwireClub::MCP::Database::Adapter.new(db_path: db_path)
server = HotwireClub::MCP::Server.new(adapter: database)
server.run
